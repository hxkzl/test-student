<!DOCTYPE html>
<html lang="zh-Hant" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŒ—æ¸¯é«˜ä¸­å­¸ç”Ÿæœƒ | PKSH Student Council</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        theme: {
                            DEFAULT: '#00c8b7',
                            dark: '#00a092',
                            light: '#e0fbf9'
                        }
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.5s ease-in-out',
                        'bounce-slow': 'bounce 3s infinite'
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0', transform: 'translateY(10px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        }
                    }
                }
            }
        }
    </script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <style>
        :root { --primary-color: #00c8b7; font-family: 'Noto Sans TC', sans-serif; }
        .text-theme { color: var(--primary-color); }
        .bg-theme { background-color: var(--primary-color); }
        .marquee-container { overflow: hidden; white-space: nowrap; position: relative; }
        .marquee-content { display: inline-block; animation: marquee 30s linear infinite; }
        @keyframes marquee { 0% { transform: translateX(100%); } 100% { transform: translateX(-100%); } }
        /* Badge Status Colors */
        .status-pending { @apply bg-yellow-100 text-yellow-800 border-yellow-200; }
        .status-approved { @apply bg-green-100 text-green-800 border-green-200; }
        .status-rejected { @apply bg-red-100 text-red-800 border-red-200; }
        .status-processing { @apply bg-blue-100 text-blue-800 border-blue-200; }
        .status-closed { @apply bg-gray-100 text-gray-800 border-gray-200; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 dark:bg-gray-900 dark:text-gray-100 flex flex-col min-h-screen relative">

    <button onclick="window.scrollTo(0,0)" id="back-to-top" class="fixed bottom-6 right-6 z-40 bg-theme text-white p-3 rounded-full shadow-lg opacity-0 pointer-events-none transition-opacity duration-300 hover:bg-theme-dark transform hover:scale-110"><i data-lucide="arrow-up" class="w-6 h-6"></i></button>

    <div class="bg-gray-800 text-white dark:bg-black text-sm py-2 px-4 marquee-container min-h-[36px]">
        <div class="marquee-content" id="marquee-text">è¼‰å…¥ä¸­...</div>
    </div>

    <header class="sticky top-0 z-30 bg-white/95 backdrop-blur shadow-sm dark:bg-gray-800/95 dark:border-b dark:border-gray-700">
        <div class="max-w-7xl mx-auto px-2 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <a href="#" class="flex-shrink-0 flex items-center gap-2" onclick="navigate('home')">
                    <img src="https://ui-avatars.com/api/?name=PKSH&background=00c8b7&color=fff" alt="Logo" class="w-10 h-10 rounded-full">
                    <span class="text-xl font-bold hidden sm:block">åŒ—æ¸¯é«˜ä¸­<span class="text-theme">å­¸ç”Ÿæœƒ</span></span>
                </a>
                <nav class="hidden xl:flex space-x-1 items-center overflow-x-auto no-scrollbar">
                    </nav>
                <div class="flex items-center space-x-2">
                    <button onclick="toggleLang()" class="px-2 py-1 text-xs font-bold border rounded">EN</button>
                    <button onclick="toggleDarkMode()" class="p-2 rounded-full"><i data-lucide="moon" id="dark-icon"></i><i data-lucide="sun" id="light-icon" class="hidden"></i></button>
                    <button id="menu-button" class="xl:hidden p-2"><i data-lucide="menu"></i></button>
                </div>
            </div>
        </div>
        <div id="mobile-menu" class="xl:hidden hidden bg-white dark:bg-gray-800 absolute w-full z-40 shadow-xl"></div>
    </header>

    <div id="confession-modal" class="fixed inset-0 z-50 bg-black/50 hidden flex items-center justify-center p-4">
        <div class="bg-white dark:bg-gray-800 rounded-2xl p-6 w-full max-w-md shadow-2xl animate-fade-in">
            <h3 class="text-2xl font-bold mb-4 text-theme">ğŸ’Œ æˆ‘è¦å‘Šç™½</h3>
            <textarea id="confession-input" rows="3" class="w-full p-2 border rounded mb-2 dark:bg-gray-700" placeholder="å…§å®¹..."></textarea>
            <input type="text" id="confession-author" class="w-full p-2 border rounded mb-4 dark:bg-gray-700" placeholder="ç½²å (å¯é¸)">
            <div class="flex justify-end gap-2">
                <button onclick="toggleConfessionModal()" class="px-4 py-2 text-gray-500">å–æ¶ˆ</button>
                <button onclick="submitConfession()" class="px-6 py-2 bg-theme text-white rounded font-bold">é€å‡º</button>
            </div>
        </div>
    </div>

    <main class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8 flex-grow w-full animate-fade-in" id="app-container"></main>

    <footer class="bg-gray-100 dark:bg-gray-800 mt-auto py-8 border-t dark:border-gray-700 text-center text-sm text-gray-500">
        <p class="font-bold text-lg mb-2 text-theme">PKSH Student Council</p>
        <p>Â© 2025 åœ‹ç«‹åŒ—æ¸¯é«˜ä¸­å­¸ç”Ÿæœƒ. All Rights Reserved.</p>
    </footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, getDocs, addDoc, doc, updateDoc, deleteDoc, serverTimestamp, query, orderBy, limit, where } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // --- Config ---
        const firebaseConfig = { apiKey: "AIzaSyDWmy__e9_7YbhBTJNvLvGVglj-fOTFWMg", authDomain: "pksh-student-council.firebaseapp.com", projectId: "pksh-student-council" };
        let db = null;
        try { db = getFirestore(initializeApp(firebaseConfig)); } catch(e) { console.warn("Firebase Init Failed (Static Mode)"); }

        // --- Data & State ---
        const I18N = {
            zh: { home: 'é¦–é ', events: 'æ´»å‹•', complaints: 'æ¬Šç›Šç”³è¨´', clubs: 'ç¤¾åœ˜', clubApps: 'ç¤¾åœ˜ç”³è«‹', downloads: 'ä¸‹è¼‰', contact: 'è¯çµ¡', admin: 'å¹¹éƒ¨å¾Œå°' },
            en: { home: 'Home', events: 'Events', complaints: 'Complaints', clubs: 'Clubs', clubApps: 'Club Apps', downloads: 'Downloads', contact: 'Contact', admin: 'Admin' }
        };

        const APP_STATE = {
            view: 'home', lang: 'zh', darkMode: false, user: null, adminTab: 'dashboard'
        };

        // æ¨¡æ“¬è§’è‰²æ¬Šé™å®šç¾©
        const ROLES = {
            PRESIDENT: { name: 'æœƒé•·', perms: ['all'] },
            ADMIN: { name: 'è¡Œæ”¿', perms: ['news', 'minutes', 'confessions'] },
            RIGHTS: { name: 'æ¬Šç›Š', perms: ['complaints'] },
            FINANCE: { name: 'è²¡å‹™', perms: ['budget'] },
            CLUB: { name: 'ç¤¾åœ˜', perms: ['club_apps'] },
            ACTIVITY: { name: 'æ´»å‹•', perms: ['event_approval'] },
            CLUB_LEADER: { name: 'ç¤¾åœ˜å¹¹éƒ¨', perms: ['submit_app'] }
        };

        const STATIC_DATA = {
            announcements: [
                { id: '1', title: '114å­¸å¹´åº¦é‡‘å‹¾ç›ƒæ­Œå”±æ¯”è³½æ±ºè³½', category: 'æ´»å‹•', date: '2025-12-24', content: 'æ±ºè³½åå–®å·²å…¬å¸ƒ...' },
                { id: '2', title: 'æœŸæœ«æ ¡å‹™æœƒè­°å­¸ç”Ÿä»£è¡¨é¸æ‹”', category: 'æœƒè­°', date: '2025-12-20', content: 'è«‹æœ‰æ„é¡˜è€…...' },
                { id: '3', title: 'å†¬å­£åˆ¶æœç©¿è‘—è¦å®šæ›´æ–°', category: 'æ¬Šç›Š', date: '2025-12-15', content: 'å³æ—¥èµ·...' }
            ],
            events: [
                { id: 'e1', title: 'é‡‘å‹¾ç›ƒæ±ºè³½', date: '2025-12-25', time: '13:00', loc: 'æ´»å‹•ä¸­å¿ƒ', limit: 100, registered: 85, type: 'Activity' },
                { id: 'e2', title: 'æœŸæœ«è€ƒé€±', date: '2026-01-16', time: '08:00', loc: 'å„ç­', type: 'Academic' }
            ],
            clubs: [
                { id: 'c1', name: 'ç†±èˆç¤¾', category: 'è—æ–‡', teacher: 'ç‹å°æ˜', intro: 'ç‡ƒç‡’ä½ çš„ç†±æƒ…ï¼', photo: 'ğŸ’ƒ' },
                { id: 'c2', name: 'ç±ƒçƒç¤¾', category: 'é‹å‹•', teacher: 'æå¤§è¯', intro: 'ç¨±éœ¸çƒå ´ï¼', photo: 'ğŸ€' }
            ],
            complaints: [], // ç”³è¨´
            clubApps: [], // ç¤¾åœ˜ç”³è«‹
            confessions: [], // å‘Šç™½
            minutes: [], // æœƒè­°è¨˜éŒ„
            registrations: [] // æ´»å‹•å ±å
        };

        // æœ¬åœ°è³‡æ–™å®¹å™¨
        let APP_DATA = JSON.parse(JSON.stringify(STATIC_DATA));
        let SYSTEM_SETTINGS = { marquee: 'ğŸ“¢ æ­¡è¿ä¾†åˆ°åŒ—æ¸¯é«˜ä¸­å­¸ç”Ÿæœƒå®˜æ–¹ç¶²ç«™ï¼' };

        // --- Helpers ---
        const t = (k) => I18N[APP_STATE.lang][k] || k;
        const formatDate = (d) => d || 'YYYY-MM-DD';
        
        // æ¨¡æ“¬ AI é«’è©±éæ¿¾
        function aiFilter(text) {
            const badWords = ['é«’è©±', 'ç¬¨è›‹', 'ç™½ç—´', 'é ', 'æ­»'];
            let isFlagged = false;
            let filtered = text;
            badWords.forEach(w => {
                if(text.includes(w)) {
                    isFlagged = true;
                    filtered = filtered.replaceAll(w, '*'.repeat(w.length));
                }
            });
            return { filtered, isFlagged };
        }

        // --- Firebase Loaders ---
        async function loadData() {
            if(!db) return;
            // ç°¡åŒ–ï¼šå¯¦éš›å°ˆæ¡ˆæ‡‰åˆ†é–‹è¼‰å…¥
            const loadCol = async (col, targetKey) => {
                const q = query(collection(db, col), orderBy('timestamp', 'desc'), limit(20));
                const snap = await getDocs(q);
                const list = [];
                snap.forEach(d => list.push({id: d.id, ...d.data()}));
                if(list.length) APP_DATA[targetKey] = list;
            };
            await Promise.all([
                loadCol('announcements', 'announcements'),
                loadCol('confessions', 'confessions'),
                loadCol('complaints', 'complaints'),
                loadCol('clubApps', 'clubApps'),
                loadCol('minutes', 'minutes')
            ]);
        }

        // --- Logic: Auth ---
        window.handleLogin = (roleKey) => {
            // æ¨¡æ“¬ç™»å…¥ï¼Œå¯¦éš›æ‡‰ä½¿ç”¨ Firebase Auth + User Document Role
            APP_STATE.user = { email: 'demo@pksh.su', role: roleKey, name: ROLES[roleKey].name };
            Swal.fire('ç™»å…¥æˆåŠŸ', `èº«ä»½ï¼š${ROLES[roleKey].name}`, 'success');
            render();
        };

        window.handleLogout = () => {
            APP_STATE.user = null;
            APP_STATE.view = 'home';
            render();
        };

        // --- Logic: CRUD ---
        window.submitComplaint = async () => {
            const content = document.getElementById('comp-content').value;
            const cat = document.getElementById('comp-cat').value;
            if(!content) return Swal.fire('éŒ¯èª¤', 'è«‹å¡«å¯«å…§å®¹', 'error');
            
            const newComp = { content, category: cat, status: 'Received', reply: '', timestamp: Date.now() };
            if(db) await addDoc(collection(db, 'complaints'), newComp);
            APP_DATA.complaints.unshift(newComp);
            
            Swal.fire('å·²æ”¶åˆ°', 'æˆ‘å€‘æœƒç›¡å¿«è™•ç†ï¼', 'success');
            render();
        };

        window.submitClubApp = async () => {
            const type = document.getElementById('app-type').value;
            const content = document.getElementById('app-content').value;
            if(!content) return Swal.fire('éŒ¯èª¤', 'è«‹å¡«å¯«å…§å®¹', 'error');

            const newApp = { type, content, clubName: 'æ¨¡æ“¬ç†±èˆç¤¾', status: 'Pending', comments: '', timestamp: Date.now() };
            if(db) await addDoc(collection(db, 'clubApps'), newApp);
            APP_DATA.clubApps.unshift(newApp);

            Swal.fire('ç”³è«‹å·²é€å‡º', 'è«‹ç­‰å¾…å¯©æ ¸', 'success');
            render();
        };

        window.registerEvent = async (eventId, title) => {
            const { value: formValues } = await Swal.fire({
                title: `å ±åï¼š${title}`,
                html: `<input id="swal-name" class="swal2-input" placeholder="å§“å"><input id="swal-sid" class="swal2-input" placeholder="å­¸è™Ÿ">`,
                focusConfirm: false,
                preConfirm: () => {
                    return [document.getElementById('swal-name').value, document.getElementById('swal-sid').value]
                }
            });

            if (formValues && formValues[0] && formValues[1]) {
                // Check duplicate (Local Simulation)
                const exists = APP_DATA.registrations.find(r => r.eventId === eventId && r.sid === formValues[1]);
                if(exists) return Swal.fire('é‡è¤‡å ±å', 'æ­¤å­¸è™Ÿå·²å ±åé', 'warning');

                APP_DATA.registrations.push({ eventId, name: formValues[0], sid: formValues[1] });
                Swal.fire('å ±åæˆåŠŸ', 'è«‹æº–æ™‚å‡ºå¸­', 'success');
                // In real app, write to subcollection events/{id}/registrations
            }
        };

        window.submitConfession = async () => {
            const raw = document.getElementById('confession-input').value;
            const author = document.getElementById('confession-author').value || 'åŒ¿å';
            if(!raw) return;

            const { filtered, isFlagged } = aiFilter(raw);
            // é è¨­éœ€è¦å¯©æ ¸ï¼Œè‹¥ AI æ¨™è¨˜å‰‡ç‰¹åˆ¥è¨»è¨˜
            const newConfess = { content: filtered, author, status: 'Pending', isFlagged, timestamp: Date.now() };
            
            if(db) await addDoc(collection(db, 'confessions'), newConfess);
            APP_DATA.confessions.unshift(newConfess); // Admin view needs to see it

            Swal.fire('å·²é€å‡º', isFlagged ? 'ç³»çµ±åµæ¸¬åˆ°æ•æ„Ÿè©ï¼Œå°‡é€²è¡Œäººå·¥å¯©æ ¸' : 'å¾…ç®¡ç†å“¡å¯©æ ¸å¾Œé¡¯ç¤º', isFlagged ? 'warning' : 'success');
            window.toggleConfessionModal();
        };

        // --- Logic: Admin Actions ---
        window.updateStatus = async (col, id, status, reply = null) => {
            if(db) {
                const data = { status };
                if(reply !== null) data.reply = reply;
                await updateDoc(doc(db, col, id), data);
            }
            // Local update for UI
            const item = APP_DATA[col].find(i => i.id === id);
            if(item) { item.status = status; if(reply) item.reply = reply; }
            Swal.fire('å·²æ›´æ–°', `ç‹€æ…‹è®Šæ›´ç‚ºï¼š${status}`, 'success');
            render();
        };

        // --- Render Views ---

        function renderHome() {
            // Quick Links
            const quickLinks = `
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                    <button onclick="navigate('complaints')" class="p-4 bg-red-100 text-red-700 rounded-xl font-bold flex flex-col items-center hover:bg-red-200 transition"><i data-lucide="alert-circle" class="mb-2"></i> æ¬Šç›Šç”³è¨´</button>
                    <button onclick="navigate('events')" class="p-4 bg-blue-100 text-blue-700 rounded-xl font-bold flex flex-col items-center hover:bg-blue-200 transition"><i data-lucide="calendar" class="mb-2"></i> æ´»å‹•å ±å</button>
                    <button onclick="navigate('clubs')" class="p-4 bg-green-100 text-green-700 rounded-xl font-bold flex flex-col items-center hover:bg-green-200 transition"><i data-lucide="users" class="mb-2"></i> ç¤¾åœ˜æŸ¥è©¢</button>
                    <button onclick="navigate('downloads')" class="p-4 bg-purple-100 text-purple-700 rounded-xl font-bold flex flex-col items-center hover:bg-purple-200 transition"><i data-lucide="download" class="mb-2"></i> èª²æ¥­è³‡æº</button>
                </div>
            `;

            // Categorized News
            const newsList = APP_DATA.announcements.slice(0, 5).map(a => `
                <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow-sm border-l-4 border-theme mb-3 hover:-translate-x-1 transition cursor-pointer">
                    <div class="flex justify-between text-xs text-gray-500 mb-1">
                        <span class="bg-gray-100 dark:bg-gray-700 px-2 py-0.5 rounded text-theme font-bold">${a.category}</span>
                        <span>${a.date}</span>
                    </div>
                    <h3 class="font-bold text-lg dark:text-white">${a.title}</h3>
                </div>
            `).join('');

            // Calendar Preview
            const eventPreview = APP_DATA.events.slice(0, 3).map(e => `
                <div class="flex items-center gap-4 py-3 border-b dark:border-gray-700">
                    <div class="text-center bg-gray-100 dark:bg-gray-700 p-2 rounded min-w-[60px]">
                        <span class="block text-xl font-bold text-theme">${e.date.split('-')[2]}</span>
                        <span class="text-xs text-gray-500">${e.date.split('-')[1]}æœˆ</span>
                    </div>
                    <div>
                        <h4 class="font-bold dark:text-white">${e.title}</h4>
                        <p class="text-xs text-gray-500">${e.time} @ ${e.loc}</p>
                    </div>
                </div>
            `).join('');

            return `
                <div class="animate-fade-in">
                    ${quickLinks}
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                        <div class="md:col-span-2">
                            <h2 class="text-2xl font-bold mb-4 flex items-center gap-2"><i data-lucide="bell"></i> æœ€æ–°å…¬å‘Š</h2>
                            ${newsList}
                        </div>
                        <div>
                            <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-md">
                                <h2 class="text-xl font-bold mb-4 flex items-center gap-2"><i data-lucide="calendar-days"></i> è¡Œäº‹æ›†</h2>
                                ${eventPreview}
                                <button onclick="navigate('events')" class="w-full mt-4 text-center text-theme font-bold text-sm hover:underline">æŸ¥çœ‹å…¨éƒ¨</button>
                            </div>
                            <div class="mt-6 bg-pink-50 dark:bg-pink-900/20 p-6 rounded-xl border border-pink-100 dark:border-pink-900">
                                <h2 class="text-xl font-bold text-pink-600 mb-2">ğŸ’Œ å‘Šç™½ç‰†</h2>
                                <div class="h-24 flex items-center justify-center text-center italic text-gray-600 dark:text-gray-300">
                                    "${APP_DATA.confessions.find(c => c.status === 'Approved')?.content || 'æš«ç„¡æ–°å‘Šç™½'}"
                                </div>
                                <button onclick="window.toggleConfessionModal()" class="w-full bg-pink-500 text-white py-2 rounded-lg font-bold hover:bg-pink-600 transition">æˆ‘è¦å‘Šç™½</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderComplaints() {
            // Student View
            return `
                <div class="max-w-3xl mx-auto animate-fade-in">
                    <h1 class="text-3xl font-bold mb-6 text-theme text-center">ğŸ—£ï¸ å­¸ç”Ÿç”³è¨´ / å»ºè­°ç³»çµ±</h1>
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg mb-8">
                        <label class="block mb-2 font-bold dark:text-white">åˆ†é¡</label>
                        <select id="comp-cat" class="w-full p-2 border rounded mb-4 dark:bg-gray-700">
                            <option value="æ ¡å‹™">æ ¡å‹™å»ºè­°</option>
                            <option value="è¨­å‚™">è¨­å‚™å ±ä¿®</option>
                            <option value="æ¬Šç›Š">å­¸ç”Ÿæ¬Šç›Š</option>
                        </select>
                        <label class="block mb-2 font-bold dark:text-white">å…§å®¹ (åŒ¿åæäº¤)</label>
                        <textarea id="comp-content" rows="4" class="w-full p-2 border rounded mb-4 dark:bg-gray-700" placeholder="è«‹è©³ç´°æè¿°å•é¡Œ..."></textarea>
                        <button onclick="submitComplaint()" class="w-full bg-theme text-white py-3 rounded-lg font-bold hover:bg-theme-dark">æäº¤æ¡ˆä»¶</button>
                    </div>
                    
                    <h2 class="text-xl font-bold mb-4 dark:text-white">æ¡ˆä»¶è¿½è¹¤ (æœ€è¿‘5ç­†)</h2>
                    <div class="space-y-4">
                        ${APP_DATA.complaints.map(c => `
                            <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow border-l-4 ${c.status==='Received'?'border-yellow-500':c.status==='Closed'?'border-gray-500':'border-green-500'}">
                                <div class="flex justify-between items-start mb-2">
                                    <span class="text-xs px-2 py-1 rounded bg-gray-100 dark:bg-gray-700">${c.category}</span>
                                    <span class="text-xs font-bold ${c.status==='Received'?'text-yellow-600':c.status==='Closed'?'text-gray-600':'text-green-600'}">${c.status === 'Received'?'å·²æ”¶åˆ°':c.status==='Processing'?'è™•ç†ä¸­':'å·²å›è¦†'}</span>
                                </div>
                                <p class="mb-2 dark:text-white">${c.content}</p>
                                ${c.reply ? `<div class="bg-gray-50 dark:bg-gray-700 p-2 rounded text-sm text-gray-600 dark:text-gray-300">ğŸ‘® å­¸ç”Ÿæœƒå›è¦†: ${c.reply}</div>` : ''}
                            </div>
                        `).join('') || '<p class="text-center text-gray-500">æš«ç„¡æ¡ˆä»¶</p>'}
                    </div>
                </div>
            `;
        }

        function renderClubApps() {
             return `
                <div class="max-w-3xl mx-auto animate-fade-in">
                    <h1 class="text-3xl font-bold mb-6 text-theme text-center">ğŸ“ ç¤¾åœ˜æ´»å‹•/å ´åœ°ç”³è«‹</h1>
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-lg mb-8">
                        <label class="block mb-2 font-bold dark:text-white">ç”³è«‹é …ç›®</label>
                        <select id="app-type" class="w-full p-2 border rounded mb-4 dark:bg-gray-700">
                            <option value="Venue">å ´åœ°å€Ÿç”¨</option>
                            <option value="Fund">ç¶“è²»ç”³è«‹</option>
                            <option value="Activity">æ´»å‹•ä¼åŠƒæ›¸</option>
                        </select>
                        <label class="block mb-2 font-bold dark:text-white">è©³ç´°å…§å®¹</label>
                        <textarea id="app-content" rows="4" class="w-full p-2 border rounded mb-4 dark:bg-gray-700" placeholder="æ™‚é–“ã€åœ°é»ã€é‡‘é¡ã€æ´»å‹•æ¦‚è¿°..."></textarea>
                        <button onclick="submitClubApp()" class="w-full bg-blue-600 text-white py-3 rounded-lg font-bold hover:bg-blue-700">é€å‡ºç”³è«‹</button>
                    </div>
                    
                    <h2 class="text-xl font-bold mb-4 dark:text-white">æˆ‘çš„ç”³è«‹ç´€éŒ„ (æ¨¡æ“¬)</h2>
                     <div class="space-y-4">
                        ${APP_DATA.clubApps.map(a => `
                            <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow flex justify-between items-center">
                                <div>
                                    <span class="text-xs font-bold text-blue-600 block">${a.type}</span>
                                    <p class="dark:text-white">${a.content}</p>
                                </div>
                                <span class="px-3 py-1 rounded text-xs font-bold ${a.status==='Pending'?'bg-yellow-100 text-yellow-800':'bg-green-100 text-green-800'}">${a.status}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
             `;
        }

        function renderAdmin() {
            if(!APP_STATE.user) {
                // Login
                return `
                    <div class="max-w-md mx-auto mt-20 p-8 bg-white dark:bg-gray-800 rounded-xl shadow-2xl text-center animate-fade-in">
                        <h1 class="text-2xl font-bold mb-6 text-theme">å­¸ç”Ÿæœƒå¹¹éƒ¨ç™»å…¥</h1>
                        <p class="mb-4 text-sm text-gray-500">è«‹é¸æ“‡è§’è‰²é€²è¡Œæ¨¡æ“¬ (Role Simulation)</p>
                        <div class="grid grid-cols-2 gap-3">
                            ${Object.keys(ROLES).map(k => `
                                <button onclick="handleLogin('${k}')" class="p-2 border rounded hover:bg-theme hover:text-white transition">${ROLES[k].name}</button>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            const role = ROLES[APP_STATE.user.role];
            const can = (perm) => role.perms.includes('all') || role.perms.includes(perm);
            const tab = APP_STATE.adminTab;

            // Sidebar Items based on Permissions
            let tabs = [];
            tabs.push({ id: 'dashboard', name: 'å„€è¡¨æ¿', icon: 'layout-dashboard' });
            if(can('news')) tabs.push({ id: 'news', name: 'å…¬å‘Šç®¡ç†', icon: 'megaphone' });
            if(can('complaints')) tabs.push({ id: 'complaints', name: 'æ¬Šç›Šæ¡ˆä»¶', icon: 'scale' });
            if(can('club_apps') || can('budget') || can('event_approval')) tabs.push({ id: 'club_apps', name: 'ç¤¾åœ˜ç”³è«‹', icon: 'files' });
            if(can('confessions')) tabs.push({ id: 'confessions', name: 'å‘Šç™½å¯©æ ¸', icon: 'heart-handshake' });
            if(can('minutes')) tabs.push({ id: 'minutes', name: 'æœƒè­°è¨˜éŒ„', icon: 'file-text' });

            let content = '';
            
            // Dashboard Content
            if(tab === 'dashboard') {
                content = `
                    <h2 class="text-2xl font-bold mb-6 dark:text-white">æ­¡è¿å›ä¾†ï¼Œ${APP_STATE.user.name}</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="bg-blue-100 p-6 rounded-xl text-blue-800">
                            <h3 class="font-bold text-2xl">${APP_DATA.complaints.filter(c=>c.status==='Received').length}</h3>
                            <p>å¾…è™•ç†ç”³è¨´</p>
                        </div>
                        <div class="bg-yellow-100 p-6 rounded-xl text-yellow-800">
                            <h3 class="font-bold text-2xl">${APP_DATA.clubApps.filter(a=>a.status==='Pending').length}</h3>
                            <p>å¾…å¯©æ ¸ç”³è«‹</p>
                        </div>
                        <div class="bg-pink-100 p-6 rounded-xl text-pink-800">
                            <h3 class="font-bold text-2xl">${APP_DATA.confessions.filter(c=>c.status==='Pending').length}</h3>
                            <p>å¾…å¯©æ ¸å‘Šç™½</p>
                        </div>
                    </div>
                `;
            } 
            // Complaints Review
            else if(tab === 'complaints') {
                content = `
                    <h2 class="text-xl font-bold mb-4 dark:text-white">æ¬Šç›Šæ¡ˆä»¶ç®¡ç†</h2>
                    <div class="space-y-4">
                        ${APP_DATA.complaints.map(c => `
                            <div class="bg-white dark:bg-gray-800 p-4 rounded shadow border-l-4 ${c.status==='Received'?'border-yellow-500':'border-green-500'}">
                                <p class="font-bold dark:text-white mb-2">${c.content}</p>
                                <div class="flex items-center gap-2 mt-2">
                                    <select onchange="updateStatus('complaints', '${c.id}', this.value)" class="p-1 border rounded text-sm">
                                        <option value="Received" ${c.status==='Received'?'selected':''}>å·²æ”¶åˆ°</option>
                                        <option value="Processing" ${c.status==='Processing'?'selected':''}>è™•ç†ä¸­</option>
                                        <option value="Replied" ${c.status==='Replied'?'selected':''}>å·²å›è¦†</option>
                                        <option value="Closed" ${c.status==='Closed'?'selected':''}>å·²çµæ¡ˆ</option>
                                    </select>
                                    <button onclick="Swal.fire('å›è¦†', '', 'info')" class="text-blue-600 text-sm hover:underline">æ’°å¯«å›è¦† Email</button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
            // Club App Review
            else if(tab === 'club_apps') {
                content = `
                    <h2 class="text-xl font-bold mb-4 dark:text-white">ç¤¾åœ˜ç”³è«‹å¯©æ ¸</h2>
                    <div class="space-y-4">
                        ${APP_DATA.clubApps.map(a => `
                             <div class="bg-white dark:bg-gray-800 p-4 rounded shadow flex justify-between items-center">
                                <div>
                                    <span class="text-xs font-bold text-gray-500">${a.clubName} | ${a.type}</span>
                                    <p class="dark:text-white">${a.content}</p>
                                </div>
                                <div class="flex gap-2">
                                    <button onclick="updateStatus('clubApps', '${a.id}', 'Approved')" class="px-3 py-1 bg-green-500 text-white rounded text-sm">æ ¸å‡†</button>
                                    <button onclick="updateStatus('clubApps', '${a.id}', 'Rejected')" class="px-3 py-1 bg-red-500 text-white rounded text-sm">é§å›</button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
            // Confessions Review
            else if(tab === 'confessions') {
                 content = `
                    <h2 class="text-xl font-bold mb-4 dark:text-white">å‘Šç™½ç‰†å¯©æ ¸</h2>
                    <div class="space-y-4">
                        ${APP_DATA.confessions.filter(c => c.status === 'Pending').map(c => `
                             <div class="bg-white dark:bg-gray-800 p-4 rounded shadow">
                                <p class="dark:text-white mb-2 ${c.isFlagged ? 'text-red-500 font-bold' : ''}">${c.isFlagged ? '[AI æ¨™è¨˜] ' : ''}${c.content}</p>
                                <div class="flex gap-2">
                                    <button onclick="updateStatus('confessions', '${c.id}', 'Approved')" class="px-3 py-1 bg-green-500 text-white rounded text-sm">é€šé</button>
                                    <button onclick="updateStatus('confessions', '${c.id}', 'Rejected')" class="px-3 py-1 bg-red-500 text-white rounded text-sm">åˆªé™¤</button>
                                </div>
                            </div>
                        `).join('') || '<p>ç„¡å¾…å¯©æ ¸å‘Šç™½</p>'}
                    </div>
                `;
            }
            // Minutes Editor
            else if(tab === 'minutes') {
                content = `
                    <h2 class="text-xl font-bold mb-4 dark:text-white">æœƒè­°è¨˜éŒ„ç·¨è¼¯</h2>
                    <input class="w-full p-2 border rounded mb-2 dark:bg-gray-700" placeholder="æœƒè­°æ¨™é¡Œ">
                    <textarea class="w-full p-2 border rounded mb-2 h-40 dark:bg-gray-700" placeholder="æœƒè­°å…§å®¹..."></textarea>
                    <button class="bg-theme text-white px-4 py-2 rounded">ç™¼å¸ƒè¨˜éŒ„</button>
                `;
            }
            else {
                content = `<p class="dark:text-white">åŠŸèƒ½é–‹ç™¼ä¸­...</p>`;
            }

            return `
                <div class="flex flex-col md:flex-row min-h-[600px] bg-white dark:bg-gray-800 rounded-xl shadow-xl overflow-hidden animate-fade-in">
                    <div class="w-full md:w-64 bg-gray-50 dark:bg-gray-900 border-r dark:border-gray-700 p-4 flex flex-col">
                        <div class="mb-6">
                            <span class="text-xs uppercase text-gray-400">Current User</span>
                            <p class="font-bold text-lg dark:text-white">${APP_STATE.user.name}</p>
                            <span class="text-xs bg-theme text-white px-2 py-0.5 rounded">${APP_STATE.user.role}</span>
                        </div>
                        <nav class="space-y-1 flex-grow">
                            ${tabs.map(t => `
                                <button onclick="APP_STATE.adminTab='${t.id}'; render();" class="w-full text-left px-4 py-3 rounded flex items-center gap-3 ${APP_STATE.adminTab===t.id ? 'bg-theme text-white' : 'hover:bg-gray-200 dark:hover:bg-gray-800 dark:text-gray-300'}">
                                    <i data-lucide="${t.icon}" class="w-4 h-4"></i> ${t.name}
                                </button>
                            `).join('')}
                        </nav>
                        <button onclick="handleLogout()" class="mt-4 w-full text-left px-4 py-2 text-red-500 hover:bg-red-50 rounded flex items-center gap-2"><i data-lucide="log-out" class="w-4 h-4"></i> ç™»å‡º</button>
                    </div>
                    <div class="flex-grow p-8 bg-gray-100 dark:bg-gray-950/50 overflow-y-auto">
                        ${content}
                    </div>
                </div>
            `;
        }
        
        // --- Core Render ---
        function render() {
            const container = document.getElementById('app-container');
            const view = APP_STATE.view;
            
            // Generate Nav
            const navItems = ['home', 'events', 'complaints', 'clubs', 'clubApps', 'downloads', 'admin'];
            const navHtml = navItems.map(k => 
                `<button onclick="navigate('${k}')" class="px-3 py-2 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700 transition whitespace-nowrap ${APP_STATE.view===k?'text-theme font-bold':''}">${t(k)}</button>`
            ).join('');
            document.querySelector('nav').innerHTML = navHtml;
            document.getElementById('mobile-menu').innerHTML = navItems.map(k => `<button onclick="navigate('${k}'); document.getElementById('mobile-menu').classList.add('hidden')" class="block w-full text-left py-3 px-4 hover:bg-gray-50 dark:hover:bg-gray-700 dark:text-white border-b dark:border-gray-700">${t(k)}</button>`).join('');

            // Marquee
            document.getElementById('marquee-text').innerText = SYSTEM_SETTINGS.marquee;

            // Route
            if(view === 'home') container.innerHTML = renderHome();
            else if(view === 'complaints') container.innerHTML = renderComplaints();
            else if(view === 'clubApps') container.innerHTML = renderClubApps();
            else if(view === 'admin') container.innerHTML = renderAdmin();
            else if(view === 'events') {
                container.innerHTML = `
                <h1 class="text-3xl font-bold mb-6 text-center text-theme">ğŸ“… æ´»å‹•å ±å</h1>
                <div class="grid gap-4 max-w-3xl mx-auto">
                    ${APP_DATA.events.map(e => `
                        <div class="bg-white dark:bg-gray-800 p-5 rounded-lg shadow border-l-4 border-blue-500 flex justify-between items-center">
                            <div>
                                <h3 class="text-xl font-bold dark:text-white">${e.title}</h3>
                                <p class="text-sm text-gray-500">${e.date} ${e.time} | ${e.loc}</p>
                            </div>
                            <button onclick="registerEvent('${e.id}', '${e.title}')" class="bg-blue-600 text-white px-4 py-2 rounded font-bold hover:bg-blue-700">å ±ååƒåŠ </button>
                        </div>
                    `).join('')}
                </div>`;
            }
            else if(view === 'clubs') {
                container.innerHTML = `
                <h1 class="text-3xl font-bold mb-6 text-center text-theme">ğŸ« ç¤¾åœ˜ä¸€è¦½è¡¨</h1>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    ${APP_DATA.clubs.map(c => `
                        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg overflow-hidden group hover:-translate-y-1 transition duration-300">
                            <div class="h-32 bg-gray-200 dark:bg-gray-700 flex items-center justify-center text-6xl">${c.photo}</div>
                            <div class="p-4">
                                <span class="text-xs bg-gray-100 dark:bg-gray-700 px-2 py-1 rounded text-gray-500 mb-2 inline-block">${c.category}</span>
                                <h3 class="text-xl font-bold dark:text-white">${c.name}</h3>
                                <p class="text-sm text-gray-500 mb-2">æŒ‡å°è€å¸«ï¼š${c.teacher}</p>
                                <p class="text-gray-600 dark:text-gray-300 text-sm line-clamp-2">${c.intro}</p>
                            </div>
                        </div>
                    `).join('')}
                </div>`;
            }
            else {
                container.innerHTML = `<div class="text-center py-20 text-gray-500">é é¢å»ºæ§‹ä¸­...</div>`;
            }

            lucide.createIcons();
            window.scrollTo(0,0);
        }

        // --- Utils ---
        window.navigate = (v) => { APP_STATE.view = v; render(); };
        window.toggleLang = () => { APP_STATE.lang = APP_STATE.lang === 'zh' ? 'en' : 'zh'; render(); };
        window.toggleDarkMode = () => { 
            document.documentElement.classList.toggle('dark'); 
            document.getElementById('dark-icon').classList.toggle('hidden');
            document.getElementById('light-icon').classList.toggle('hidden');
        };
        window.toggleConfessionModal = () => document.getElementById('confession-modal').classList.toggle('hidden');
        document.getElementById('menu-button').onclick = () => document.getElementById('mobile-menu').classList.toggle('hidden');

        // Init
        loadData().then(render);
        render(); // Initial render
    </script>
</body>
</html>
